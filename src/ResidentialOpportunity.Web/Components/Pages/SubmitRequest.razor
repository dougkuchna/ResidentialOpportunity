@page "/submit-request"
@rendermode InteractiveServer
@using System.Text.Json
@using System.Xml.Serialization
@using ResidentialOpportunity.Application.DTOs
@using Microsoft.EntityFrameworkCore
@using ResidentialOpportunity.Application.Services
@using ResidentialOpportunity.Domain.Enums
@inject ServiceRequestService RequestService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject Infrastructure.Data.AppDbContext DbContext

<PageTitle>Submit Service Request</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">Submit a Service Request</MudText>
<MudText Typo="Typo.body1" Class="mb-4">Fill in the form below or upload a JSON/XML file to pre-fill the fields.</MudText>

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <MudAlert Severity="Severity.Error" Class="mb-4" ShowCloseIcon="true" CloseIconClicked="() => _errorMessage = null">@_errorMessage</MudAlert>
}

@if (!string.IsNullOrEmpty(_uploadMessage))
{
    <MudAlert Severity="Severity.Success" Class="mb-4">@_uploadMessage</MudAlert>
}

<MudPaper Class="pa-4 mb-4" Elevation="1">
    <MudText Typo="Typo.subtitle2" Class="mb-2">Import from file (optional)</MudText>
    <InputFile OnChange="HandleFileUpload" accept=".json,.xml" />
</MudPaper>

<EditForm Model="_command" OnValidSubmit="HandleSubmit" FormName="ServiceRequestForm">
    <DataAnnotationsValidator />

    <MudPaper Class="pa-4 mb-4" Elevation="1">
        <MudText Typo="Typo.h6" GutterBottom="true">Contact Information *</MudText>
        <MudGrid>
            <MudItem xs="12" sm="4">
                <MudTextField @bind-Value="_command.Name" Label="Full Name" Variant="Variant.Outlined" Required="true" />
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudTextField @bind-Value="_command.Email" Label="Email" InputType="InputType.Email" Variant="Variant.Outlined" Required="true" />
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudTextField @bind-Value="_command.Phone" Label="Phone" Variant="Variant.Outlined" Required="true" />
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudPaper Class="pa-4 mb-4" Elevation="1">
        <MudText Typo="Typo.h6" GutterBottom="true">Service Address *</MudText>
        <MudGrid>
            <MudItem xs="12">
                <MudTextField @bind-Value="_command.Street" Label="Street" Variant="Variant.Outlined" Required="true" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="_command.City" Label="City" Variant="Variant.Outlined" Required="true" />
            </MudItem>
            <MudItem xs="6" sm="3">
                <MudTextField @bind-Value="_command.State" Label="State" Variant="Variant.Outlined" Required="true" MaxLength="2" />
            </MudItem>
            <MudItem xs="6" sm="3">
                <MudTextField @bind-Value="_command.ZipCode" Label="ZIP Code" Variant="Variant.Outlined" Required="true" MaxLength="5" />
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudPaper Class="pa-4 mb-4" Elevation="1">
        <MudText Typo="Typo.h6" GutterBottom="true">Issue Details *</MudText>
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudSelect @bind-Value="_command.IssueCategory" Label="Issue Category" Variant="Variant.Outlined">
                    @foreach (var cat in Enum.GetValues<IssueCategory>())
                    {
                        <MudSelectItem Value="cat">@cat</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudSelect @bind-Value="_command.UrgencyLevel" Label="Urgency Level" Variant="Variant.Outlined">
                    @foreach (var level in Enum.GetValues<UrgencyLevel>())
                    {
                        <MudSelectItem Value="level">@level</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="_command.IssueDescription" Label="Description of Issue" Variant="Variant.Outlined"
                              Lines="5" Required="true" Placeholder="Describe your HVAC issue in detail..." />
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudPaper Class="pa-4 mb-4" Elevation="1">
        <MudText Typo="Typo.h6" GutterBottom="true">Optional Information</MudText>
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="_command.EquipmentDetails" Label="Equipment Details" Variant="Variant.Outlined"
                              Placeholder="e.g., Carrier AC unit, Model XYZ, installed 2019" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="_command.PreferredSchedule" Label="Preferred Schedule" Variant="Variant.Outlined"
                              Placeholder="e.g., Weekday mornings, ASAP for emergencies" />
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary"
               Disabled="_isSubmitting" StartIcon="@Icons.Material.Filled.Send" Size="Size.Large">
        @(_isSubmitting ? "Submitting..." : "Submit Request")
    </MudButton>
</EditForm>

@code {
    private CreateServiceRequestCommand _command = new()
    {
        IssueCategory = IssueCategory.Other,
        UrgencyLevel = UrgencyLevel.Standard
    };

    private bool _isSubmitting;
    private string? _errorMessage;
    private string? _uploadMessage;
    private Guid? _customerId;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (userId is not null)
            {
                var customer = await DbContext.Customers
                    .FirstOrDefaultAsync(c => c.IdentityUserId == userId);

                if (customer is not null)
                {
                    _customerId = customer.Id;
                    _command.Name = customer.ContactInfo.Name;
                    _command.Email = customer.ContactInfo.Email;
                    _command.Phone = customer.ContactInfo.Phone;
                }
            }
        }
        catch { /* anonymous user, no prefill */ }
    }

    private async Task HandleSubmit()
    {
        _isSubmitting = true;
        _errorMessage = null;

        try
        {
            var result = await RequestService.CreateAsync(_command, _customerId);
            Navigation.NavigateTo($"/request-confirmation/{result.Id}");
        }
        catch (FluentValidation.ValidationException ex)
        {
            _errorMessage = string.Join(" ", ex.Errors.Select(e => e.ErrorMessage));
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        _uploadMessage = null;
        _errorMessage = null;

        try
        {
            var file = e.File;
            if (file.Size > 1024 * 100) // 100KB max
            {
                _errorMessage = "File too large. Maximum 100KB.";
                return;
            }

            using var stream = file.OpenReadStream(maxAllowedSize: 1024 * 100);
            using var reader = new StreamReader(stream);
            var content = await reader.ReadToEndAsync();

            CreateServiceRequestCommand? parsed = null;

            if (file.Name.EndsWith(".json", StringComparison.OrdinalIgnoreCase))
            {
                parsed = JsonSerializer.Deserialize<CreateServiceRequestCommand>(content,
                    new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            }
            else if (file.Name.EndsWith(".xml", StringComparison.OrdinalIgnoreCase))
            {
                var serializer = new XmlSerializer(typeof(CreateServiceRequestCommand));
                using var stringReader = new StringReader(content);
                parsed = serializer.Deserialize(stringReader) as CreateServiceRequestCommand;
            }

            if (parsed is not null)
            {
                _command = parsed;
                _uploadMessage = $"Fields pre-filled from {file.Name}";
            }
            else
            {
                _errorMessage = "Could not parse file. Ensure it matches the expected format.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error reading file: {ex.Message}";
        }
    }
}
