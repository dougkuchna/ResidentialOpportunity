@page "/find-providers"
@rendermode InteractiveServer
@using ResidentialOpportunity.Application.DTOs
@using ResidentialOpportunity.Application.Services
@inject ProviderLookupService ProviderService

<PageTitle>Find HVAC Providers</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">Find Local HVAC Providers</MudText>
<MudText Typo="Typo.body1" Class="mb-4">Enter your ZIP code to find qualified HVAC service providers in your area.</MudText>

<MudGrid Class="mb-4">
    <MudItem xs="12" sm="6" md="4">
        <MudTextField @bind-Value="_zipCode" Label="ZIP Code" Variant="Variant.Outlined" MaxLength="5"
                      Placeholder="e.g. 62704" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search"
                      OnAdornmentClick="SearchProviders" OnKeyDown="HandleKeyDown" />
    </MudItem>
    <MudItem xs="12" sm="6" md="2" Class="d-flex align-end">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SearchProviders"
                   Disabled="_isSearching" StartIcon="@Icons.Material.Filled.Search">
            @(_isSearching ? "Searching..." : "Search")
        </MudButton>
    </MudItem>
</MudGrid>

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
}

@if (_hasSearched && _providers is not null)
{
    @if (_providers.Count == 0)
    {
        <MudAlert Severity="Severity.Info" Class="mb-4">
            No providers found for ZIP code <b>@_lastSearchedZip</b>.
            Try a nearby ZIP code or <MudLink Href="/submit-request">submit a request</MudLink>.
        </MudAlert>
    }
    else
    {
        <MudText Typo="Typo.h6" Class="mb-3">@_providers.Count Provider(s) near @_lastSearchedZip</MudText>
        <MudGrid>
            @foreach (var provider in _providers)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="2">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">@provider.CompanyName</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">@provider.City, @provider.State</MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudText><MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" Class="mr-1" />@provider.Phone</MudText>
                            <MudText><MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" Class="mr-1" /><MudLink Href="@($"mailto:{provider.Email}")">@provider.Email</MudLink></MudText>
                            @if (!string.IsNullOrEmpty(provider.Website))
                            {
                                <MudText><MudIcon Icon="@Icons.Material.Filled.Language" Size="Size.Small" Class="mr-1" /><MudLink Href="@provider.Website" Target="_blank">@provider.Website</MudLink></MudText>
                            }
                            @if (!string.IsNullOrEmpty(provider.Description))
                            {
                                <MudText Typo="Typo.body2" Class="mt-2">@provider.Description</MudText>
                            }
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
}

@code {
    private string _zipCode = string.Empty;
    private string _lastSearchedZip = string.Empty;
    private bool _isSearching;
    private bool _hasSearched;
    private string? _errorMessage;
    private List<ProviderSearchResult>? _providers;

    private async Task SearchProviders()
    {
        _errorMessage = null;

        if (string.IsNullOrWhiteSpace(_zipCode) || _zipCode.Length != 5 || !_zipCode.All(char.IsDigit))
        {
            _errorMessage = "Please enter a valid 5-digit ZIP code.";
            return;
        }

        _isSearching = true;
        _lastSearchedZip = _zipCode;

        try
        {
            var results = await ProviderService.SearchByZipCodeAsync(_zipCode);
            _providers = results.ToList();
            _hasSearched = true;
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error searching providers: {ex.Message}";
        }
        finally
        {
            _isSearching = false;
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchProviders();
        }
    }
}
