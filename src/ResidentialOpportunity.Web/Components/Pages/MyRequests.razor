@page "/my-requests"
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using ResidentialOpportunity.Application.DTOs
@using ResidentialOpportunity.Application.Services
@inject ServiceRequestService RequestService
@inject AuthenticationStateProvider AuthStateProvider
@inject Infrastructure.Data.AppDbContext DbContext

<PageTitle>My Requests</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">My Service Requests</MudText>

@if (_isLoading)
{
    <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    <MudText Class="mt-2">Loading your requests...</MudText>
}
else if (_requests is null || _requests.Count == 0)
{
    <MudAlert Severity="Severity.Info">
        You haven't submitted any service requests yet.
        <MudLink Href="/submit-request">Submit your first request</MudLink>.
    </MudAlert>
}
else
{
    <MudText Class="mb-3">You have <b>@_requests.Count</b> service request(s).</MudText>

    @foreach (var request in _requests)
    {
        <MudCard Elevation="2" Class="mb-3">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">@request.IssueCategory â€” @request.UrgencyLevel</MudText>
                </CardHeaderContent>
                <CardHeaderActions>
                    <MudChip T="string" Color="Color.Success" Size="Size.Small">@request.Status</MudChip>
                </CardHeaderActions>
            </MudCardHeader>
            <MudCardContent>
                <MudText>@request.IssueDescription</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                    <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" /> @request.Street, @request.City, @request.State @request.ZipCode
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Size="Size.Small" /> @request.CreatedAt.LocalDateTime.ToString("MMM d, yyyy h:mm tt")
                </MudText>
            </MudCardContent>
            <MudCardActions>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" Href="@($"/request-confirmation/{request.Id}")"
                           StartIcon="@Icons.Material.Filled.Visibility" Size="Size.Small">View Details</MudButton>
            </MudCardActions>
        </MudCard>
    }
}

@code {
    private List<ServiceRequestDto>? _requests;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (userId is not null)
            {
                var customer = await DbContext.Customers
                    .FirstOrDefaultAsync(c => c.IdentityUserId == userId);

                if (customer is not null)
                {
                    var results = await RequestService.GetByCustomerIdAsync(customer.Id);
                    _requests = results.ToList();
                }
            }
        }
        catch
        {
            _requests = null;
        }
        finally
        {
            _isLoading = false;
        }
    }
}
